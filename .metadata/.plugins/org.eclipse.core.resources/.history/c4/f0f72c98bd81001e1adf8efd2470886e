//include Necesarios
#include "stm32f4xx_hal.h"        // Se incluyo para poder usar las funciones de la HAL
#include "API_debounce.h"         // Se incluyo por las deficiones que necesita el punto c
#include "main.h"                // se incluyo por las macros de los leds y pulsadores.


//VARIABLES GLOBALES PRIVADAS: corresponde a la variables necesarias para lo retardos
// pero no interesa que sean visibles solo dentro del archivo.
static delay_t retardo;         //estructura del retardo
static tick_t duracion = 40;    //Retardo de 40ms

//Prototipo de funciones
void debounceFSM_init(debounceState_t* FSM){
	*FSM = BUTTON_UP;
};  // Inicializar la maquina de etado


void debounceFSM_update(debounceState_t* FSM){
	switch(*FSM){

	case BUTTON_UP:
		if (HAL_GPIO_ReadPin(GPIOA, 0x0001) == 1) {
			*FSM = BUTTON_FALLING;
			delayInit(&retardo, duracion);
		}else{
			*FSM = BUTTON_UP;
		}
	break;

	case BUTTON_FALLING:
		if(delayRead(&retardo) == 1){
			if(HAL_GPIO_ReadPin(GPIOA, 0x0001) == 1){
				*FSM = BUTTON_DOWN;
			}
			else{
				*FSM = BUTTON_UP;
			}
		}
	break;

	case BUTTON_DOWN:
		if(HAL_GPIO_ReadPin(GPIOA, 0x0001) == 0){
			*FSM = BUTTON_RAISING;
			delayInit(&retardo, duracion);
		}else{
			*FSM = BUTTON_DOWN;
		}
	break;

	case BUTTON_RAISING:
		if(delayRead(&retardo) == 1){
			if(HAL_GPIO_ReadPin(GPIOA, 0x0001) == 0){
				*FSM = BUTTON_UP;
			}else{
				*FSM = BUTTON_DOWN;
			}
		}
	break;
	};
}; //Actuliza la maquina de estado


void buttonPressed(){
	HAL_GPIO_WritePin(GPIOG, LD3_Pin, GPIO_PIN_SET);
};    //Da la salida de boton precionado (enciende el led)


void buttonReleased(){
	HAL_GPIO_WritePin(GPIOG, LD3_Pin, GPIO_PIN_RESET);
};   //Da la salida de boton NO precionado (Apaga el led)
